---
output:
  pdf_document:
  title: "Heatmaps of functional enrichments"
---

```{r setupstate, echo=FALSE}
library(knitr)
opts_chunk$set(tidy=TRUE, cache=FALSE,  highlight=TRUE, figalign="center", echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, tidy.opts=list(keep.blank.line=FALSE, width.cutoff=120))
options(width=200)
```


```{r libraries, results='hide', message=FALSE, warning=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(pheatmap)
library(RColorBrewer)
```



```{r variables}
baseDir <- "/Users/johnhutchinson/Work/projects/pk_functional_gwas/"
dataDir <- file.path(baseDir, "data")
resultsDir <- file.path(baseDir, "results")
metaDir <- file.path(baseDir, "meta")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000")
```


```{r import}
metadata <- read_csv(file.path(dataDir, "results.oaat.overall.sci.csv"))
metadata <- select(metadata, i, cell_type, Group_2)


data <- read_delim(file.path(dataDir, "final.17trait.3BC.4IDs.txt"), delim="\t")
data <- dplyr::inner_join(metadata, data, by=c("i", "cell_type"))
```

\pagebreak

## Using all data

```{r heatmapsetup1}
datamatrix <- as.data.frame(select(data, -cell_type, -Mark, -i, -Group_2, -Name) )
row.names(datamatrix) <- seq(1:nrow(datamatrix))

annotations <- as.data.frame(select(data, Group_2, Mark))
row.names(annotations) <- seq(1:nrow(datamatrix))
names(annotations) <- c("Cell\ Type", "Mark")

tol4qualitative=c("#4477AA", "#117733", "#DDCC77", "#CC6677")
tol11qualitative=c("#332288", "#6699CC", "#88CCEE", "#44AA99", "#117733", "#999933", "#DDCC77", "#661100", "#CC6677", "#882255", "#AA4499")

# Specify colors
# heatmap annotation colors
mark_colors <- tol4qualitative
names(mark_colors) <- unique(unlist(annotations$Mark))
celltype_colors <- tol11qualitative
names(celltype_colors) <- unique(unlist(annotations$`Cell\ Type`))
ann_colors = list(Mark=mark_colors, `Cell\ Type` = celltype_colors)
```


Unscaled

```{r heatmapnoscale1, fig.cap="Unscaled", fig.height=6, fig.width=8}

pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="none", annotation_colors=ann_colors, border_color="NA", cutree_rows=6)
```

\pagebreak

Scaled by row

```{r heatmaprowscale1, fig.cap="Row scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="row", annotation_colors=ann_colors, border_color="NA" )
```

\pagebreak

Scaled by column

```{r heatmapcolumnscale1, fig.cap="Column scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="column", annotation_colors=ann_colors, border_color="NA" )
```
 
\pagebreak

## Using all data, splitting the heatmap by cluster

```{r heatmapnoscale2, fig.cap="Unscaled", fig.height=6, fig.width=8}

pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="none", annotation_colors=ann_colors, border_color="NA", cutree_rows=5)
```

\pagebreak

Scaled by row

```{r heatmaprowscale2, fig.cap="Row scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="row", annotation_colors=ann_colors, border_color="NA", cutree_rows=5 )
```

\pagebreak

Scaled by column

```{r heatmapcolumnscale2, fig.cap="Column scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="column", annotation_colors=ann_colors, border_color="NA" , cutree_rows=4)
```
 

## Subsetting to the H3K27ac marks, splitting the heatmap by cluster


```{r heatmapsetup2}
subset.data <- filter(data, Mark=="H3K27ac")
datamatrix <- as.data.frame( select(subset.data, -cell_type, -Mark, -i, -Group_2, -Name))
row.names(datamatrix) <- seq(1:nrow(datamatrix))

annotations <- as.data.frame(select(subset.data, Group_2))
row.names(annotations) <- seq(1:nrow(datamatrix))
names(annotations) <- c("Cell\ Type")

 tol9qualitative=c("#332288", "#88CCEE", "#44AA99", "#117733", "#999933", "#DDCC77", "#CC6677", "#882255", "#AA4499")

# Specify colors
# heatmap annotation colors
celltype_colors <- tol9qualitative
names(celltype_colors) <- unique(unlist(annotations$`Cell\ Type`))
ann_colors = list(`Cell\ Type` = celltype_colors)
```

```{r heatmapnoscale3, fig.cap="Unscaled", fig.height=6, fig.width=8}

pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="none", annotation_colors=ann_colors, border_color="NA", cutree_rows=4)
```

\pagebreak

Scaled by row

```{r heatmaprowscale3, fig.cap="Row scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="row", annotation_colors=ann_colors, border_color="NA", cutree_rows=4 )
```

\pagebreak

Scaled by column

```{r heatmapcolumnscale3, fig.cap="Column scaled",fig.height=6, fig.width=8}
pheatmap(datamatrix,show_rownames=FALSE,annotation_row=annotations, treeheight_row = 0, treeheight_col = 0,  color=colorRampPalette((brewer.pal(n = 11, name="RdBu")))(100), annotation_legend=TRUE, fontsize_col=10, legend=TRUE, scale="column", annotation_colors=ann_colors, border_color="NA" , cutree_rows=4)
```
 
