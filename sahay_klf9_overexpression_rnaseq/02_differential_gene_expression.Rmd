---
title: "Sahay Lab Klf9 differential expression analysis"
date: "`r BiocStyle::doc_date()`"
author: "Michael J. Steinbaugh"
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(DESeq2)
library(basejump)  # devtools::install_github("steinbaugh/basejump")
library(tidyverse)
# S4Vectors standardGeneric `rename()` masks `dplyr::rename()`

data(dds,
     dds_rlog,
     dds_vst,
     heatmap_annotation,
     metadata,
     normalized_counts,
     summary_data)
```

[Bioconductor]: https://bioconductor.org
[Ensembl]: http://useast.ensembl.org/Mus_musculus/Info/Index
[R]: https://www.r-project.org

[`DESeq2`]: https://bioconductor.org/packages/release/bioc/html/DESeq2.html
[`sailfish`]: http://www.cs.cmu.edu/~ckingsf/software/sailfish

[`expt_vs_control_de_dn.csv`]: expt_vs_control_de_dn.csv
[`expt_vs_control_de_up.csv`]: expt_vs_control_de_up.csv
[`expt_vs_control_de.csv`]: expt_vs_control_de.csv
[`expt_vs_control.csv`]: expt_vs_control.csv
[`normalized_counts.csv`]: normalized_counts.csv
[`raw_counts.csv`]: raw_counts.csv
[`tpm.csv`]: tpm.csv

```{r ensembl}
library(biomaRt)
ensembl_version <- listMarts(host = "useast.ensembl.org") %>%
    dplyr::filter(biomart == "ENSEMBL_MART_ENSEMBL") %>%
    dplyr::select(version) %>% .[[1]]
mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
mart_options <- listAttributes(mart)
metadata_ensembl <-
    getBM(mart = mart,
          attributes = c("ensembl_gene_id",
                         "external_gene_name",
                         "description",
                         "gene_biotype")) %>%
    arrange(ensembl_gene_id)
saveData(metadata_ensembl)
rm(mart)
detach("package:biomaRt", unload = TRUE)
```



# Overview

Differential gene expression (DGE) analysis of count data from [`sailfish`][] [@patro2014sailfish] was performed with the [Bioconductor][] [R][] package [`DESeq2`][] [@love2014deseq2]. Counts were fit to a negative binomial model [@hilbe2011negative], and dispersion estimates were generated using the mean values from the maximum likelihood estimate of log<sub>2</sub> fold changes, optimizing the Cox-Reid adjusted profile likelihood [@cox-reid1987].



# [`DESeq2`][] fit modeling

Several quality metrics were first assessed to explore the fit of the model, before differential expression analysis was performed. We observe that the modeling fit is good.

The plots below show the standard deviation of normalized counts (`normalized_counts`) using `log2()`, `DESeq2::rlog()`, and variance stabilizing (`DESeq2::vst()`) transformations by `rank(mean)`. The transformations greatly reduce the standard deviation, with `rlog` stabilizing the variance best across the mean. Therefore, we will use the `rlog` transformed counts for any downstream count visualizations.


## Variance stabilization

### `log2`

```{r deseq2_qc_log2}
library(vsn)
meanSdPlot(log2(normalized_counts + 1))
```

### `rlog` (used)

```{r deseq2_qc_rlog}
meanSdPlot(assay(dds_rlog))
```

### `vst`

```{r deseq2_qc_vst}
meanSdPlot(assay(dds_vst))
detach("package:vsn", unload = TRUE)
```


## Dispersion

The following plot shows the dispersion by mean of normalized counts. We expect the dispersion to decrease as the mean of normalized counts increases. This looks good.

```{r dispersion_estimates}
plotDispEsts(dds)
```



# Alpha level (a.k.a. false discovery rate) cutoffs

Let's take a look at the number of genes we get with different false discovery rate (FDR) cutoffs. These tests subset *P* values that have been multiple test corrected using the Benjamini Hochberg (BH) method [@benjamini-hochberg1995].


## `alpha` = 0.1 (default)

```{r}
summary(results(dds))
```


## `alpha` = 0.05

```{r}
summary(results(dds, alpha = 0.05))
```


## `alpha` = 0.01 (used)

```{r}
summary(results(dds, alpha = 0.01))
alpha <- 0.01
```

## `alpha` = 0.001

```{r}
summary(results(dds, alpha = 0.001))
```


## `alpha` = 1e-06

```{r}
summary(results(dds, alpha = 1e-06))
```



# Results

```{r res}
res <- results(dds, alpha = alpha)
saveData(res)
# res@metadata$alpha
# mcols(res)
```

```{r expt_vs_control}
expt_vs_control <- res %>%
    as.data.frame %>%
    rownames_to_column("ensembl_gene_id") %>%
    as_tibble %>%
    left_join(metadata_ensembl, by = "ensembl_gene_id") %>%
    setNamesSnake %>%
    arrange(padj)

expt_vs_control_de <- subset(expt_vs_control, padj < alpha)
expt_vs_control_de_dn <- subset(expt_vs_control_de, log2_fold_change < 0)
expt_vs_control_de_up <- subset(expt_vs_control_de, log2_fold_change > 0)

saveData(expt_vs_control,
         expt_vs_control_de,
         expt_vs_control_de_dn,
         expt_vs_control_de_up)
writeCsv(expt_vs_control,
         expt_vs_control_de,
         expt_vs_control_de_dn,
         expt_vs_control_de_up)
```

- `r nrow(expt_vs_control)` genes evaluated
- `r nrow(expt_vs_control_de)` genes differentially expressed, at an alpha of `r alpha`
- `r nrow(expt_vs_control_de_up)` genes up-regulated
- `r nrow(expt_vs_control_de_dn)` genes down-regulated



# Plots

## Mean average (MA)

An MA plot compares transformed counts on `M` (log ratio) and `A` (mean average) scales [@yang2002ma].

```{r ma}
plotMA(res, ylim = c(-1, 1))
```


## Volcano

```{r volcano_cutoff}
volcano_plot_text_alpha <- 1e-6
volcano_plot_text_lfc <- 1
```

A volcano plot compares significance (BH-adjusted *P* value) against fold change (log<sub>2</sub>) [@cui2003volcano; @li2014volcano]. We can see **Klf9** on the volcano plot clearly as the top upregulated gene. Genes in the green box with text labels have an adjusted *P* value below `r volcano_plot_text_alpha` and a LFC above `r volcano_plot_text_lfc`. These are likely the top candidate genes of interest.

```{r volcano, fig.width=7, fig.height=7}
library(CHBUtils)
library(ggrepel)
# https://github.com/hbc/CHBUtils/blob/master/R/volcanoPlot.R
# `volcano_density_plot()` requires a `data.frame` with two columns:
# `logFC` and `Adjusted.Pvalue`
volcano_df <- res %>%
    as.data.frame %>%
    dplyr::rename(Adjusted.Pvalue = padj,
                  logFC = log2FoldChange) %>%
    # Filter zero counts, select columns
    .[!is.na(.$logFC), c("logFC", "Adjusted.Pvalue")]
volcano_plot_text <- volcano_df %>%
    rownames_to_column("ensembl_gene_id") %>%
    left_join(metadata_ensembl, by = "ensembl_gene_id") %>%
    mutate(name = external_gene_name) %>%
    select(logFC, Adjusted.Pvalue, name) %>%
    arrange(name) %>%
    subset(Adjusted.Pvalue < volcano_plot_text_alpha &
               (logFC < -volcano_plot_text_lfc |
                    logFC > volcano_plot_text_lfc))
volcano_density_plot(volcano_df,
                     lfc.cutoff = 0,
                     plot_text = volcano_plot_text,
                     pval.cutoff = alpha)
detach("package:CHBUtils", unload = TRUE)
```


## Heatmap

This plot shows only differentially expressed genes (n = `r nrow(expt_vs_control_de)`) on a per-sample basis. We have scaled the data by row and used the `ward.D2` method for clustering [@ward1963clustering]. We can see that the samples cluster nicely across conditions.

```{r heatmap_de}
dds_rlog %>%
    assay %>%
    # DE genes only
    .[expt_vs_control_de$ensembl_gene_id, ] %>%
    pheatmap::pheatmap(., annotation = heatmap_annotation,
                       clustering_distance_cols = "correlation",
                       clustering_method = "ward.D2",
                       main = "Differentially expressed genes",
                       scale = "row",
                       show_rownames = FALSE)
```



# Tables

Only the top 50 up- and down-regulated genes (arranged by *P* value) are shown.

```{r top_table}
top_table <- function(df, caption = NULL) {
    df %>%
        dplyr::select(-c(description, lfc_se, pvalue, stat)) %>%
        head(n = 50) %>%
        printTable(., caption = caption)
}
top_table(expt_vs_control_de_up, "Top upregulated genes")
top_table(expt_vs_control_de_dn, "Top downregulated genes")
```



# File downloads

## Differential expression

- [`expt_vs_control.csv`][]: All genes
- [`expt_vs_control_de.csv`][]: Differentially expressed (DE) genes, both negative and positive
- [`expt_vs_control_de_dn.csv`][]: Downregulated DE genes
- [`expt_vs_control_de_up.csv`][]: Upregulated DE genes

These files contain the following columns:

- `ensembl_gene_id`: [Ensembl][] gene identifier
- `base_mean`: Mean of the normalized counts per gene for all samples
- `log2_fold_change`: log<sub>2</sub> fold change
- `lfc_se`: log<sub>2</sub> standard error
- `stat`: Wald statistic
- `pvalue`: Walt test *P* value
- `padj`: BH adjusted Wald test *P* value (corrected for multiple comparisons; FDR)
- `external_gene_name`: [Ensembl][] name (a.k.a. symbol)
- `description`: [Ensembl][] description
- `gene_biotype`: [Ensembl][] biotype (e.g. `protein_coding`)


## Counts

### Normalized (preferred)

We advise using only these files to assess and/or graph genes on an individual basis:

- [`normalized_counts.csv`][]: Normalized counts, generated by [`DESeq2`][]
- [`tpm.csv`][]: Transcripts per million (TPM), generated by [`sailfish`][]

### Raw

[`raw_counts.csv`][] (generated by [`sailfish`][]) should **only** be used to perform a new differential expression analysis. These counts will vary across samples due to differences in sequencing depth, and have not been normalized.



# Methods

Differential expression analysis was performed by [`DESeq2`] [@love2014deseq2]. Gene annotations were obtained from `r ensembl_version`.


## R session information

`sessionInfo()` output of the workstation that generated this report:

```{r session_info}
sessionInfo()
```



# References
